{% load static %}{% load price_format %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Favorites - Rent Ease</title>
    <link rel="stylesheet" href="{% static 'styles/main_site.css' %}">
    <script src="{% static 'js/theme.js' %}"></script>
</head>
<body>
<div class="main-container">
    <!-- Header -->
    <header class="top_panel">
        <a href="{% url 'offers' %}" class="top-panel-logo-link"><topPanelLogo>
            <img src="{% static 'images/logo.svg' %}" alt="Rent Ease Logo" style="height: 40px; width: auto;">
        </topPanelLogo></a>
        <div class="header-right">
            <div class="theme-toggle-container">
                <span class="theme-toggle-label">Light</span>
                <label class="theme-toggle-switch">
                    <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                    <span class="theme-toggle-slider"></span>
                </label>
                <span class="theme-toggle-label">Dark</span>
            </div>
            {% if tenant %}
                <TopPanelButton onclick="location.href='{% url 'favorites' %}'">‚ù§Ô∏è Favorites</TopPanelButton>
                <TopPanelButton onclick="location.href='{% url 'my_contracts' %}'">üìÑ Contracts</TopPanelButton>
                <TopPanelButton onclick="location.href='{% url 'profile' %}'">Profile</TopPanelButton>
                <TopPanelButton onclick="location.href='{% url 'logout' %}'">Logout ({{ tenant.name }})</TopPanelButton>
            {% else %}
                <TopPanelButton onclick="location.href='{% url 'register' %}'">Rejestracja</TopPanelButton>
                <TopPanelButton onclick="location.href='{% url 'login' %}'">Logowanie</TopPanelButton>
            {% endif %}
        </div>
    </header>

    <!-- Page Title -->
    <div class="page-header">
        <h1 class="page-title">My Favorites</h1>
    </div>

    <!-- Listings Container -->
    <div class="listings-container">
        {% if offers %}
        <div class="offers-grid">
            {% for offer in offers %}
                <div class="offer_card" onclick="location.href='{% url 'offer_detail' offer.id %}'">
                    <div class="offer_image-wrapper">
                        {% for photo in offer.photos.all|slice:":1" %}
                            <img src="{{ photo.data_uri }}" alt="{{ offer.title }}" class="offer_image">
                        {% empty %}
                            <img src="{% static 'images/no_photo.png' %}" alt="No photo" class="offer_image">
                        {% endfor %}
                        {% if offer.status == 'Unavailable' %}
                            <span class="offer_status_badge">Unavailable</span>
                        {% endif %}
                        {% if tenant %}
                        <button class="favorite-button" 
                                data-offer-id="{{ offer.id }}" 
                                data-is-favorite="true"
                                onclick="event.stopPropagation(); toggleFavorite({{ offer.id }}, this);"
                                aria-label="Remove from favorites">
                            <span class="favorite-icon">‚ù§Ô∏è</span>
                        </button>
                        {% endif %}
                    </div>
                    <div class="offer_content">
                        <h3 class="offer_title">{{ offer.title }}</h3>
                        
                        {% if offer.location %}
                        <div class="offer_location">
                            <span class="offer_location-icon">üìç</span>
                            <span class="offer_location-text">{{ offer.location }}</span>
                        </div>
                        {% endif %}
                        
                        <div class="offer_key_specs">
                            {% if offer.number_of_rooms %}
                            <div class="offer_spec_item">
                                <span class="offer_spec_icon">üõèÔ∏è</span>
                                <span class="offer_spec_value">{{ offer.number_of_rooms }}</span>
                                <span class="offer_spec_label">Rooms</span>
                            </div>
                            {% endif %}
                            
                            {% if offer.area %}
                            <div class="offer_spec_item">
                                <span class="offer_spec_icon">üìê</span>
                                <span class="offer_spec_value">{{ offer.area }}</span>
                                <span class="offer_spec_label">m¬≤</span>
                            </div>
                            {% elif offer.square_footage %}
                            <div class="offer_spec_item">
                                <span class="offer_spec_icon">üìê</span>
                                <span class="offer_spec_value">{{ offer.square_footage }}</span>
                                <span class="offer_spec_label">m¬≤</span>
                            </div>
                            {% endif %}
                            
                            {% if offer.floor %}
                            <div class="offer_spec_item">
                                <span class="offer_spec_icon">üè¢</span>
                                <span class="offer_spec_value">{{ offer.floor }}</span>
                                <span class="offer_spec_label">Floor</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="offer_footer">
                            <div class="offer_price_container">
                                <span class="offer_price">{{ offer.price|price_format }} z≈Ç</span>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-offers">
            <div class="no-offers-content">
                <div class="no-offers-icon">‚ù§Ô∏è</div>
                <h2 class="no-offers-title">No Favorites Yet</h2>
                <p class="no-offers-message">You haven't saved any offers yet.</p>
                <p class="no-offers-suggestion">Go back to the <a href="{% url 'offers' %}" class="no-offers-link">homepage</a> to find your dream home.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function toggleFavorite(offerId, buttonElement) {
        const icon = buttonElement.querySelector('.favorite-icon');
        const isCurrentlyFavorite = buttonElement.dataset.isFavorite === 'true';
        
        // Optimistic update - immediately change the UI
        if (isCurrentlyFavorite) {
            icon.textContent = 'ü§ç';
            buttonElement.dataset.isFavorite = 'false';
            buttonElement.classList.remove('favorite-active');
        } else {
            icon.textContent = '‚ù§Ô∏è';
            buttonElement.dataset.isFavorite = 'true';
            buttonElement.classList.add('favorite-active');
        }
        
        // Add animation
        buttonElement.classList.add('favorite-animate');
        setTimeout(() => {
            buttonElement.classList.remove('favorite-animate');
        }, 300);
        
        // Send API request
        fetch(`/api/favorites/${offerId}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update state based on server response
                if (data.isFavorite) {
                    icon.textContent = '‚ù§Ô∏è';
                    buttonElement.dataset.isFavorite = 'true';
                    buttonElement.classList.add('favorite-active');
                } else {
                    icon.textContent = 'ü§ç';
                    buttonElement.dataset.isFavorite = 'false';
                    buttonElement.classList.remove('favorite-active');
                    // If on favorites page and item was removed, reload page
                    if (window.location.pathname === '/favorites') {
                        setTimeout(() => {
                            window.location.reload();
                        }, 500);
                    }
                }
            } else {
                // Revert on error
                if (isCurrentlyFavorite) {
                    icon.textContent = '‚ù§Ô∏è';
                    buttonElement.dataset.isFavorite = 'true';
                    buttonElement.classList.add('favorite-active');
                } else {
                    icon.textContent = 'ü§ç';
                    buttonElement.dataset.isFavorite = 'false';
                    buttonElement.classList.remove('favorite-active');
                }
                showToast('Failed to update favorite. Please try again.', 'error');
            }
        })
        .catch(error => {
            console.error('Error toggling favorite:', error);
            // Revert on error
            if (isCurrentlyFavorite) {
                icon.textContent = '‚ù§Ô∏è';
                buttonElement.dataset.isFavorite = 'true';
                buttonElement.classList.add('favorite-active');
            } else {
                icon.textContent = 'ü§ç';
                buttonElement.dataset.isFavorite = 'false';
                buttonElement.classList.remove('favorite-active');
            }
            showToast('Failed to update favorite. Please try again.', 'error');
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function showToast(message, type = 'info') {
        // Simple toast notification
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? '#e74c3c' : '#51b86c'};
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>
</body>

